<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <th:block th:include="fragment/header"></th:block>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">
        <th:block th:include="fragment/nav"></th:block>

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="col-xl-12 col-lg-7 no-padding">
               <div class="card shadow mb-4">
                  <div class="card-body">
                      <h1 class="h3 mb-2 text-gray-800">점검대상 현황</h1>
                      <p>점검대상관리를 통해 대상을 등록하고 삭제할 수 있습니다.</p>
                  </div>
              </div>
          </div>

          <div class="row">
            <div class="col-xl-12 col-lg-7">
            <!-- DataTales Example -->
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                  <h6 class="m-0 font-weight-bold text-primary">점검대상 목록</h6>
                  <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                      <div class="dropdown-header">점검대상 관리:</div>
                      <a class="dropdown-item" href="#" id="object_reg"><i class="fas fa-plus"></i> 점검대상 등록</a>
                      <a class="dropdown-item" href="#" id="object_edit"><i class="fas fa-plus"></i> 점검대상 수정</a>
                      <a class="dropdown-item" href="#" id="object_excel"><i class="fas fa-plus-square"></i> 점검대상 일괄등록</a>
                      <a class="dropdown-item" href="#" id="object_del"><i class="fas fa-minus-square"></i> 점검대상 삭제</a>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <ul class="nav nav-tabs category_tabs list-tabs" role="tablist">
                    <li class="active">
                      <a href="#" data-toggle="tab" id=all>전체</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="OS">OS</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="DBMS">DBMS</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="WEB">WEB/WAS</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="Network">Network</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="보안장비">보안장비</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="관리보안">관리보안</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" id="개인정보보호">개인정보보호</a>
                    </li>
                  </ul>
                  <div class="table-responsive">
                    <table class="table table-bordered" id="ManageObjects_dataTable" width="100%" cellspacing="0">
                      <thead>
                      <tr>
                        <th><input type="checkbox" id="check_all"></th>
                        <th>유형</th>
                        <th>이름</th>
                        <th>용도</th>
                        <th>담당조직</th>
                        <th>운영부서1</th>
                        <th>운영부서2</th>
                        <th>IP주소</th>
                        <th>위치정보</th>
                      </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- end of row-->

        </div>
        <!-- /.container-fluid -->
        <!-- 레이어 팝업 -->
      <div class="layer" id="manage_obj_popup">
          <div class="bg"></div>
          <div id="layer1" class="pop-layer" style="display: none; width: 800px;">
              <div class="pop-container">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="row">
                        <h6>점검대상 등록</h6>
                        <div class="reg-contents">
                            <div class="inputs">대상 유형 선택<span class="required"> *</span><hr>

                              <label for="cat_OS" class="btn btn-info btn-icon-split btn-sm cat_OS cat_btn">
                                <span class="text">OS</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_OS" value="OS">
                              <label for="cat_DBMS" class="btn btn-info btn-icon-split btn-sm cat_DBMS cat_btn">
                                <span class="text">DBMS</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_DBMS" value="DBMS">
                              <label for="cat_WEB" class="btn btn-info btn-icon-split btn-sm cat_WEB cat_btn">
                                <span class="text">WEB</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_WEB" value="WEB">
                              <label for="cat_Network" class="btn btn-info btn-icon-split btn-sm cat_Network cat_btn">
                                <span class="text">Network</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_Network" value="Network">
                              <label for="cat_gear" class="btn btn-info btn-icon-split btn-sm cat_gear cat_btn">
                                <span class="text">보안장비</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_gear" value="보안장비">
                              <label for="cat_manage" class="btn btn-info btn-icon-split btn-sm cat_manage cat_btn">
                                <span class="text">관리보안</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_manage" value="관리보안">
                              <label for="cat_private" class="btn btn-info btn-icon-split btn-sm cat_private cat_btn">
                                <span class="text">개인정보보호</span>
                              </label>
                              <input type="radio" name="obj_type" id="cat_private" value="개인정보보호">
                            </div> <!-- end of inputs -->

                            <h5>운영정보</h5><hr>
                            <div class="inputs">
                              <div class="subtitle">담당조직<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="full text-inputs" name="oGroup">
                                  <option value="">선택하세요</option>
                                  <option value="마블시스템그룹">마블시스템그룹</option>
                                  <option value="마블시스템그룹2">마블시스템그룹2</option>
                                </select>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">운영부서/담당자1<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="first text-inputs" name="part1">
                                  <option value="">선택하세요</option>
                                  <option value="기술부">기술부</option>
                                  <option value="개발부">개발부</option>
                                </select>
                                <select class="second text-inputs" name="part1">
                                  <option value="">선택하세요</option>
                                  <option value=" 김지호">김지호</option>
                                  <option value=" 김현동">김현동</option>
                                </select>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">운영부서/담당자2<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="first text-inputs" name="part2">
                                  <option value="">선택하세요</option>
                                  <option value="기술부">기술부</option>
                                  <option value="개발부">개발부</option>
                                </select>
                                <select class="second text-inputs" name="part2">
                                  <option value="">선택하세요</option>
                                  <option value=" 김지호">김지호</option>
                                  <option value=" 김현동">김현동</option>
                                </select>
                              </div>
                            </div>
                            <h5>세부정보</h5><hr>
                            <div class="inputs">
                              <div class="subtitle">호스트명<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="oName">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">IP주소(호스트)<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="IP">
                              </div>
                            </div>
                            <div class="inputs">
                              <div class="subtitle">용도<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="purpose">
                              </div>
                            </div>
                            <div class="inputs">
                              <div class="subtitle">설치위치정보<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="location">
                              </div>
                            </div>
                            <input type="submit" id="reg_btn" data-oid="" value="등록하기">
                        </div> <!-- end of reg-contents -->

                      </div>
                  </div>
              </div>
          </div>
        <div id="layer2" class="pop-layer" style="display: none; width: 800px;">
              <div class="pop-container">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="row">
                        <h6>점검대상 등록</h6>
                        <div class="reg-contents">
                            <div class="inputs">대상 유형 선택<span class="required"> *</span><hr>

                              <label for="s_cat_OS" class="btn btn-info btn-icon-split btn-sm s_cat_OS cat_btn">
                                <span class="text">OS</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_OS" value="OS">
                              <label for="s_cat_DBMS" class="btn btn-info btn-icon-split btn-sm s_cat_DBMS cat_btn">
                                <span class="text">DBMS</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_DBMS" value="DBMS">
                              <label for="s_cat_WEB" class="btn btn-info btn-icon-split btn-sm s_cat_WEB cat_btn">
                                <span class="text">WEB</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_WEB" value="WEB">
                              <label for="s_cat_Network" class="btn btn-info btn-icon-split btn-sm s_cat_Network cat_btn">
                                <span class="text">Network</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_Network" value="Network">
                              <label for="s_cat_gear" class="btn btn-info btn-icon-split btn-sm s_cat_gear cat_btn">
                                <span class="text">보안장비</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_gear" value="보안장비">
                              <label for="s_cat_manage" class="btn btn-info btn-icon-split btn-sm s_cat_manage cat_btn">
                                <span class="text">관리보안</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_manage" value="관리보안">
                              <label for="s_cat_private" class="btn btn-info btn-icon-split btn-sm s_cat_private cat_btn">
                                <span class="text">개인정보보호</span>
                              </label>
                              <input type="radio" name="type" id="s_cat_private" value="개인정보보호">
                            </div> <!-- end of inputs -->

                            <h5>운영정보</h5><hr>
                            <div class="inputs">
                              <div class="subtitle">담당조직<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="full text-inputs" name="oGroup">
                                  <option value="">선택하세요</option>
                                  <option value="마블시스템그룹">마블시스템그룹</option>
                                  <option value="마블시스템그룹2">마블시스템그룹2</option>
                                </select>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">운영부서/담당자1<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="first text-inputs" name="part1">
                                  <option value="">선택하세요</option>
                                  <option value="기술부">기술부</option>
                                  <option value="개발부">개발부</option>
                                </select>
                                <select class="second text-inputs" name="part1">
                                  <option value="">선택하세요</option>
                                  <option value=" 김지호">김지호</option>
                                  <option value=" 김현동">김현동</option>
                                </select>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">운영부서/담당자2<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="first text-inputs" name="part2">
                                  <option value="">선택하세요</option>
                                  <option value="기술부">기술부</option>
                                  <option value="개발부">개발부</option>
                                </select>
                                <select class="second text-inputs" name="part2">
                                  <option value="">선택하세요</option>
                                  <option value=" 김지호">김지호</option>
                                  <option value=" 김현동">김현동</option>
                                </select>
                              </div>
                            </div>
                            <h5>세부정보</h5><hr>
                            <div class="inputs">
                              <div class="subtitle">호스트명<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="oName">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">IP주소(호스트)<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="IP">
                              </div>
                            </div>
                            <div class="inputs">
                              <div class="subtitle">용도<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="purpose">
                              </div>
                            </div>
                            <div class="inputs">
                              <div class="subtitle">설치위치정보<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="location">
                              </div>
                            </div>
                            <input type="submit" id="update_btn" data-oid="" value="등록하기">
                        </div> <!-- end of reg-contents -->

                      </div>
                  </div>
              </div>
          </div>
          <div id="layer3" class="pop-layer" style="display: none; width: 600px;">
              <div class="pop-container">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="card mb-4">

                          <div class="card-header">
                              <h6 class="m-0 font-weight-bold text-primary">일괄 등록</h6>
                          </div>

                          <div class="card-body">
                              <form id="excelUploadForm" name="excelUploadForm" enctype="multipart/form-data" method="post" action= "/excelUploadObj.do">
                                  <div class="contents">
                                      <div>첨부파일은 한개만 등록 가능합니다.</div>
                                      <dl class="vm_name">
                                          <dt class="down w90">첨부 파일</dt>
                                          <dd><input id="excelFile" type="file" name="excelFile" /></dd>
                                      </dl>
                                  </div>
                                  <div class="bottom">
                                      <button type="button" id="addExcelImpoartBtn" class="btn" onclick="check()" ><span>추가</span></button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <!-- 레이어 팝업 end -->

      </div>
      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Copyright &copy; Your Website 2020</span>
          </div>
        </div>
      </footer>
      <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <th:block th:include="fragment/footer"></th:block>
<script src="http://malsup.github.com/jquery.form.js"></script>
  <script>

    function Change_tables(search){
      if(search == "all") {
        var search = "";
      }
      $('#ManageObjects_dataTable').DataTable( {
        destroy: true,
        ajax : {
            "type" : "POST",
            "url" : "getObjectDatatable.do",
            "dataType" : "JSON",
        },
        language : lang_kor,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        "search": {
          "search" : search
        },
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrBtip>>"+"",
        buttons: buttons,
        columns : [
            {
                data : "oid",
                defaultContent:"",
                'targets': 0,
                'searchable': false,
                'className': 'dt-2',
                "render": function (data) {
                    return '<input type="checkbox" name="MeasureChecked" data-oid="'+data+'" value="'+data+'" class="checked">';
                }
              },
            {data : "type", 'className': ''},
            {data : "oname", 'className': 'dt-10'},
            {data : "purpose", 'className': 'dt-16'},
            {data : "ogroup", 'className': 'dt-16'},
            {data : "part1"},
            {data : "part2"},
            {data : "ip"},
            {data : "location", 'orderable': false, 'className': 'dt-6'},
        ],
      });

    }

    // 엑셀 업로드 체크
    function check() {
        var file = $("#excelFile").val();
        if (file == "" || file == null) {
            alert("파일을 선택해주세요.");
            return false;
        } else if (!checkFileType(file)) {
            alert("엑셀 파일만 업로드 가능합니다.");
            return false;
        }
        if (confirm("업로드 하시겠습니까?")) {
            var options = {
                success : function(data) {
                    console.log(data);
                    swal({
                        'title' : '완료!',
                        'text'  : '일괄등록을 완료하였습니다. \n',
                        'icon'  : 'success'
                    }, function() {
                        location.reload();
                    });
                },
                type : "POST"
            };
            $("#excelUploadForm").ajaxSubmit(options);
        }
    }

    function insertObject(datas) {
        $.ajax({
            url : "insertObject.do",
            type : "POST",
            dataType : "json",
            data : datas,
          success : function(data) {
              console.log(data);
              swal({
                  title : '등록 완료!',
              }, function() {
                  location.reload();
              });
          }
        });
    }

    function updateObject(oid = false) {
        $.ajax({
            url : "updateObject.do",
            type : "POST",
            dataType : "json",
            data : {
                'oid' : oid,
                'type' : $('#layer2 input[name="obj_type"]:checked').val(),
                'oGroup' : $('#layer2 select[name="oGroup"]').val(),
                'part1' : $('#layer2 select[name="part1"]').val(),
                'part2' : $('#layer2 select[name="part2"]').val(),
                'oName' : $('#layer2 input[name="oName"]').val(),
                'IP' : $('#layer2 input[name="IP"]').val(),
                'purpose' : $('#layer2 input[name="purpose"]').val(),
                'location' : $('#layer2 input[name="location"]').val(),
            },success : function(data) {
              swal({
                  title : '등록 완료!',
              }, function() {
                  location.reload();
              });
          }
        });
    }

    function DeleteObject(checked) {
        var url = "deleteObjects.do";
        $.ajax({
            url : url,
            type : "POST",
            dataType : "json",
            data : {'oid' : checked },
        });
        return swal({
            title : '삭제 완료!',
        }, function() {
            location.reload();
        });
    }

    function editObject() {
      var oid = $('.checked:checked').data('oid');
      $.ajax({
            url : "getObject.do",
            type : "POST",
            dataType : "json",
            data : {
                'oid' : oid
            },success : function(data) {
              var part1 = data.data.part1;
              var part2 = data.data.part2;
              var part1_val = part1.split(',');
              var part2_val = part2.split(',');
              $('#layer2 input[name="obj_type"]:radio[value="'+data.data.type+'"]').prop('checked',true);
              $('#layer2 select[name="oGroup"]').val(data.data.ogroup);
              $('#layer2 select[name="part1"].first').val(part1_val[0]);
              $('#layer2 select[name="part1"].second').val(part1_val[1]);
              $('#layer2 select[name="part2"].first').val(part2_val[0]);
              $('#layer2 select[name="part2"].second').val(part2_val[1]);
              $('#layer2 input[name="oName"]').val(data.data.oname);
              $('#layer2 input[name="IP"]').val(data.data.ip);
              $('#layer2 input[name="purpose"]').val(data.data.purpose);
              $('#layer2 input[name="location"]').val(data.data.location);
              $('#update_btn').attr('data-oid',data.data.oid);
        }
        });
      layer_open('layer2');
    }

    $(document).ready(function() {

      $('#ManageObjects_dataTable').DataTable( {
        ajax : {
            "type" : "POST",
            "url" : "getObjectDatatable.do",
            "dataType" : "JSON",
        },
        language : lang_kor,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrBtip>>"+"",
        buttons: buttons,
        columns : [
            {
              data : "oid",
              defaultContent:"",
              'targets': 0,
              'searchable': false,
              'className': 'dt-2',
              "render": function (data) {
                  return '<input type="checkbox" name="MeasureChecked" data-oid="'+data+'" value="'+data+'" class="checked">';
              }
              },
            {data : "type", 'className': ''},
            {data : "oname",},
            {data : "purpose",},
            {data : "ogroup",},
            {data : "part1"},
            {data : "part2"},
            {data : "ip"},
            {data : "location", 'orderable': false,},
        ],
      });

      $('#reg_btn').click(function(e) {
        e.preventDefault();
        var datas = {
          'type': $('input[name="obj_type"]:checked').val(),
          'oGroup': $('select[name="oGroup"]').val(),
          'part1': $('select[name="part1"]').val(),
          'part2': $('select[name="part2"]').val(),
          'oName': $('input[name="oName"]').val(),
          'IP': $('input[name="IP"]').val(),
          'purpose': $('input[name="purpose"]').val(),
          'location': $('input[name="location"]').val(),
        };
        insertObject(datas);
      })

      $('ul.category_tabs li').click(function(){
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
        var search = $(this).children().attr('id');
        Change_tables(search);
      });

      $('#MeasureRegister_dataTable tr').click(function(e){
        e.preventDefault();
        location.href = '/m_detail?iid=10188';
      });

      $('#check_all').on('change',function() {
        var checked = $(this).is(':checked');
        if(checked) {
          $('.checked').prop('checked',true);
        } else {
          $('.checked').prop('checked',false);
        }
      });

      $('#object_reg').click(function(e) {
        e.preventDefault();
        layer_open("layer1");
      });

      $('#object_edit').click(function(e) {
        e.preventDefault();
        editObject();
      });

      $('#object_excel').click(function(e) {
         layer_open('layer3');
      });

      $('#update_btn').click(function(e) {
        e.preventDefault();
        var oid = $(this).data('oid');
        updateObject(oid);
      });

      $('#object_del').click(function(e) {
        e.preventDefault();

        var checkBoxArr = [];

        $('input[name="MeasureChecked"]:checked').each(function() {
          checkBoxArr.push($(this).val());
        });

        if(checkBoxArr.length < 1) {
          swal({
            'title' : '',
            'text' : '삭제할 대상을 선택해주세요.',
            'type' : 'warning',
          });
        } else {
          swal({
              title : '점검대상 삭제',
              text : '선택한 점검대상을 삭제하시겠습니까?',
              type : "warning",
              showCancelButton : true,
              confirmButtonClass : "btn-danger",
              confirmButtonText : "삭제",
              cancelButtonText : "아니오",
          }, function(isConfirm) {
              if(isConfirm) {
                DeleteObject(checkBoxArr);
                location.reload();
              }
          });
        }

      });

      $('input[name="type"]').click(function(e) {
        e.preventDefault();
        var checked_id = $(this).attr('id');
        var label = $('label.' + checked_id);
        $('label.cat_btn').removeClass('btn-primary').addClass('btn-info');
        label.removeClass('btn-info').addClass('btn-primary');
      });

    });
  </script>
