<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <th:block th:include="fragment/header"></th:block>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">
        <th:block th:include="fragment/nav"></th:block>

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="col-xl-12 col-lg-7 no-padding">
               <div class="card shadow mb-4">
                  <div class="card-body">
                      <h1 class="h3 mb-2 text-gray-800">점검항목 현황</h1>
                      <p>점검항목관리를 통해 항목을 등록하고 삭제할 수 있습니다.</p>
                  </div>
              </div>
          </div>

          <div class="row">
            <div class="col-xl-12 col-lg-7">
            <!-- DataTales Example -->
              <div class="card shadow mb-4">
              <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">점검항목 목록</h6>
                <div class="dropdown no-arrow">
                  <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                  </a>
                  <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                    <div class="dropdown-header">점검항목 관리:</div>
                    <a class="dropdown-item" href="#" id="conf_reg"><i class="fas fa-plus"></i> 점검항목 등록</a>
                    <a class="dropdown-item" href="#" id="conf_edit"><i class="fas fa-plus"></i> 점검항목 수정</a>
                    <a class="dropdown-item" href="#" id="conf_del"><i class="fas fa-minus-square"></i> 점검항목 삭제</a>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <select class="table-filter" id="table-filter">
                  <option value="보안관리">보안관리</option>
                  <option value="김지호">김지호</option>
                </select>
                <select class="table-filter" id="table-filter-2">
                  <option value="보안관리">보안관리</option>
                  <option value="김지호">김지호</option>
                </select>
                <div class="table-responsive">
                  <table class="table table-bordered ManageConfluence" id="ManageConfluence_dataTable" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                      <th class="detail"><i class="fas fa-plus"></i></th>
                      <th class="check"><input type="checkbox" id="check_all"></th>
                      <th class="confCategory">분류</th>
                      <th class="name">항목명</th>
                      <th class="danger">위험도</th>
                      <th class="require">요구수준</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
            </div>
          </div> <!-- end of row-->

        </div>
        <!-- /.container-fluid -->
        <!-- 레이어 팝업 -->
      <div class="layer" id="manage_conf_popup">
          <div class="bg"></div>
          <div id="layer1" class="pop-layer" style="display: none; width: 800px;">
              <div class="pop-container">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="row">
                        <h6>점검항목 등록</h6>
                          <div class="reg-contents">
                            <form action="/register_conf" method="post">
                            <div class="inputs">
                              항목 유형 선택 <span class="required"> *</span><hr>
                              <select class="full text-inputs" name="type">
                                <option value="">선택하세요</option>
                                <option value="OS">OS</option>
                                <option value="DBMS">DBMS</option>
                                <option value="Network">Network</option>
                                <option value="보안장비">보안장비</option>
                                <option value="관리보안">관리보안</option>
                                <option value="개인정보보호">개인정보보호</option>
                                <option value="Web/Mob 점검">Web/Mob 점검</option>
                              </select>
                            </div> <!-- end of inputs -->

                            <div class="inputs">
                              <div class="subtitle">점검항목분류<span class="required"> *</span></div>
                              <div class="contents">
                                <label for="cat_OS" class="btn btn-info btn-icon-split btn-sm cat_OS cat_btn">
                                  <span class="text">OS</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_OS" value="OS">

                                  <label for="cat_DBMS" class="btn btn-info btn-icon-split btn-sm cat_DBMS cat_btn">
                                      <span class="text">DBMS</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_DBMS" value="DBMS">

                                  <label for="cat_WEB" class="btn btn-info btn-icon-split btn-sm cat_WEB cat_btn">
                                      <span class="text">WEB</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_WEB" value="WEB">

                                  <label for="cat_Network" class="btn btn-info btn-icon-split btn-sm cat_Network cat_btn">
                                      <span class="text">Network</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_Network" value="Network">

                                  <label for="cat_gear" class="btn btn-info btn-icon-split btn-sm cat_gear cat_btn">
                                      <span class="text">보안장비</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_gear" value="보안장비">

                                  <label for="cat_manage" class="btn btn-info btn-icon-split btn-sm cat_manage cat_btn">
                                      <span class="text">관리보안</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_manage" value="관리보안">

                                  <label for="cat_private" class="btn btn-info btn-icon-split btn-sm cat_private cat_btn">
                                      <span class="text">개인정보보호</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="cat_private" value="개인정보보호">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">점검항목명<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="cName">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">점검항목내용<span class="required"> *</span></div>
                              <div class="contents">
                                <textarea class="full text-inputs" name="content"></textarea>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">위험도<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="first text-inputs" name="risk">
                                  <option value="">선택하세요</option>
                                  <option value="High">High</option>
                                  <option value="Medium">Medium</option>
                                  <option value="Low">Low</option>
                                </select>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">요구수준<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="demand">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">준수기준<span class="required"> *</span></div>
                              <div class="contents">
                                <textarea name="comply" class="full text-inputs"></textarea>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">지침 및 메뉴얼<span class="required"> *</span></div>
                              <div class="contents">
                                <textarea name="manual" class="full text-inputs"></textarea>
                              </div>
                            </div>
                              <input type="submit" class="btn btn-primary btn-icon-split" value="등록하기">
                              </form>
                          </div> <!-- end of reg-contents -->

                      </div>
                  </div>
              </div>
          </div>
        <div id="layer2" class="pop-layer" style="display: none; width: 800px;">
              <div class="pop-container">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="row">
                        <h6>점검항목 등록</h6>
                          <div class="reg-contents">
                            <div class="inputs">
                              항목 유형 선택 <span class="required"> *</span><hr>
                              <select class="full text-inputs" name="type">
                                <option value="">선택하세요</option>
                                <option value="OS">OS</option>
                                <option value="DBMS">DBMS</option>
                                <option value="Network">Network</option>
                                <option value="보안장비">보안장비</option>
                                <option value="관리보안">관리보안</option>
                                <option value="개인정보보호">개인정보보호</option>
                                <option value="Web/Mob 점검">Web/Mob 점검</option>
                              </select>
                            </div> <!-- end of inputs -->

                            <div class="inputs">
                              <div class="subtitle">점검항목분류<span class="required"> *</span></div>
                              <div class="contents">
                                <label for="s_cat_OS" class="btn btn-info btn-icon-split btn-sm s_cat_OS cat_btn">
                                  <span class="text">OS</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_OS" value="OS">

                                  <label for="s_cat_DBMS" class="btn btn-info btn-icon-split btn-sm s_cat_DBMS cat_btn">
                                      <span class="text">DBMS</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_DBMS" value="DBMS">

                                  <label for="s_cat_WEB" class="btn btn-info btn-icon-split btn-sm s_cat_WEB cat_btn">
                                      <span class="text">WEB</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_WEB" value="WEB">

                                  <label for="s_cat_Network" class="btn btn-info btn-icon-split btn-sm s_cat_Network cat_btn">
                                      <span class="text">Network</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_Network" value="Network">

                                  <label for="s_cat_gear" class="btn btn-info btn-icon-split btn-sm s_cat_gear cat_btn">
                                      <span class="text">보안장비</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_gear" value="보안장비">

                                  <label for="s_cat_manage" class="btn btn-info btn-icon-split btn-sm s_cat_manage cat_btn">
                                      <span class="text">관리보안</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_manage" value="관리보안">

                                  <label for="s_cat_private" class="btn btn-info btn-icon-split btn-sm s_cat_private cat_btn">
                                      <span class="text">개인정보보호</span>
                                  </label>
                                  <input type="radio" name="confCategory" id="s_cat_private" value="개인정보보호">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">점검항목명<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="cName">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">점검항목내용<span class="required"> *</span></div>
                              <div class="contents">
                                <textarea class="full text-inputs" name="content"></textarea>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">위험도<span class="required"> *</span></div>
                              <div class="contents">
                                <select class="first full text-inputs" name="risk">
                                  <option value="">선택하세요</option>
                                  <option value="High">High</option>
                                  <option value="Medium">Medium</option>
                                  <option value="Low">Low</option>
                                </select>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">요구수준<span class="required"> *</span></div>
                              <div class="contents">
                                <input type="text" class="full text-inputs" name="demand">
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">준수기준<span class="required"> *</span></div>
                              <div class="contents">
                                <textarea name="comply" class="full text-inputs"></textarea>
                              </div>
                            </div>

                            <div class="inputs">
                              <div class="subtitle">지침 및 메뉴얼<span class="required"> *</span></div>
                              <div class="contents">
                                <textarea name="manual" class="full text-inputs"></textarea>
                              </div>
                            </div>
                              <input type="submit" id="update_btn" class="btn btn-primary btn-icon-split" value="등록하기">
                          </div> <!-- end of reg-contents -->

                      </div>
                  </div>
              </div>
          </div>

      </div>
      <!-- 레이어 팝업 end -->

      </div>
      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Copyright &copy; Your Website 2020</span>
          </div>
        </div>
      </footer>
      <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <th:block th:include="fragment/footer"></th:block>

  <script>

    function format ( d ) {
      return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
          '<tr>'+
            '<td class="c_detail_th">점검항목 내용</td>'+
            '<td class="c_detail_tb">'+d.content+'</td>'+
          '</tr>'+
          '<tr>'+
            '<td class="c_detail_th">준수기준</td>'+
            '<td class="c_detail_tb">'+d.comply+'</td>'+
          '</tr>'+
          '<tr>'+
            '<td class="c_detail_th">지침 및 메뉴얼</td>'+
            '<td class="c_detail_tb">'+d.manual+'</td>'+
          '</tr>'+
        '</table>';
    }

    function DeleteObject(checked) {
      swal({
        'title' : '',
        'text' : '삭제가 완료되었습니다.',
      });
    }

    function editConf() {
      var cid = $('.checked:checked').data('cid');
      $.ajax({
            url : "getConf.do",
            type : "POST",
            dataType : "json",
            data : {
                'cid' : cid
            },success : function(data) {
              console.log(data);

              $('#layer2 input[name="confCategory"]:radio[value="'+data.data.confCategory+'"]').prop('checked',true);
              $('#layer2 select[name="type"]').val(data.data.type);
              $('#layer2 select[name="risk"]').val(data.data.risk);
              $('#layer2 textarea[name="content"]').val(data.data.content);
              $('#layer2 input[name="cName"]').val(data.data.cname);
              $('#layer2 input[name="demand"]').val(data.data.demand);
              $('#layer2 textarea[name="comply"]').val(data.data.comply);
              $('#layer2 textarea[name="manual"]').val(data.data.manual);
              $('#update_btn').attr('data-cid',data.data.cid);
        }
        });
      layer_open('layer2');
    }

    function updateConf(cid) {
      $.ajax({
            url : "updateConf.do",
            type : "POST",
            dataType : "json",
            data : {
                'cid'           : cid,
                'confCategory'  : $('#layer2 input[name="confCategory"]:checked').val(),
                'cname'         : $('#layer2 select[name="type"]').val(),
                'type'          : $('#layer2 select[name="type"]').val(),
                'risk'          : $('#layer2 select[name="risk"]').val(),
                'content'       : $('#layer2 textarea[name="content"]').val(),
                'comply'        : $('#layer2 textarea[name="comply"]').val(),
                'demand'        : $('#layer2 input[name="demand"]').val(),
                'manual'        : $('#layer2 textarea[name="manual"]').val(),
            },success : function(data) {
              swal({
                  title : '등록 완료!',
              }, function() {
                  location.reload();
              });
          }
        });
    }

    $(document).ready(function() {

      var table = $('#ManageConfluence_dataTable').DataTable( {
        ajax : {
          type : "POST",
          url : "getConfDatatable.do",
        },
        destroy : true,
        language : lang_kor,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrtip>>"+"",
        columnDefs: [{
          className: "name",
          "targets": [ 2 ]
        }],
        columns : [
          {
            className:'details-control dt-2',
            orderable:false,
            data:null,
            defaultContent: '',
            render: function() {
              return '<img src="/img/plus_icon.png" style="width:100%;">';
            }
          },
          {
            data : "cid",
            defaultContent:"",
            targets: 0,
            searchable: false,
            className:'dt-2',
            render: function (data) {
              return '<input type="checkbox" name="MeasureChecked" data-cid="'+data+'" value="'+data+'" class="checked">';
            }
          },
          {
            data : "type",
            className : 'dt-10'
          },
          {
            data : "cname",
            className : 'dt-40'
          },
          {
            data : "risk",
          },
          {
            data : "demand",
            className : ''
          },
        ],

      });

      // Add event listener for opening and closing details
    $('#ManageConfluence_dataTable tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table.row( tr );

        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    } );

      $('.table-filter').on('change', function(){
         table.search(this.value).draw();
      });

      $('#check_all').on('change',function() {
        var checked = $(this).is(':checked');
        if(checked) {
          $('.checked').prop('checked',true);
        } else {
          $('.checked').prop('checked',false);
        }
      });

      $('#conf_reg').click(function(e) {
        e.preventDefault();
        layer_open("layer1");
      });

      $('#conf_edit').click(function(e) {
        e.preventDefault();
        editConf();
      });

      $('#update_btn').click(function() {
        var cid = $(this).data('cid');
        updateConf(cid);
      });

      $('#conf_del').click(function(e) {
        e.preventDefault();

        var checkBoxArr = [];

        $('input[name="MeasureChecked"]:checked').each(function() {
          checkBoxArr.push($(this).val());
        });

        if(checkBoxArr.length < 1) {
          swal({
            'title' : '',
            'text' : '삭제할 항목을 선택해주세요.',
            'type' : 'warning',
          });
        } else {
          swal({
              title : '점검항목 삭제',
              text : '선택한 점검항목을 삭제하시겠습니까?',
              type : "warning",
              showCancelButton : true,
              confirmButtonClass : "btn-danger",
              confirmButtonText : "삭제",
              cancelButtonText : "아니오",
          }, function(isConfirm) {
              if(isConfirm) {
                DeleteObject(checkBoxArr);
              }
          });
        }

      });

      $('input[name="confCategory"]').click(function(e) {
        e.preventDefault();
        var checked_id = $(this).attr('id');
        var label = $('label.' + checked_id);
        $('label.cat_btn').removeClass('btn-primary').addClass('btn-info');
        label.removeClass('btn-info').addClass('btn-primary');
      });

      $('ul.confluence_detail li').click(function(){
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
        var c_id = $(this).children().attr('id');
        $('.content-box .inners').removeClass('active');
        $('.content-box .'+c_id).addClass('active');
      });

    });
  </script>
