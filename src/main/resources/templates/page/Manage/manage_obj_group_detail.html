<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <th:block th:include="fragment/header"></th:block>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">
        <th:block th:include="fragment/nav"></th:block>

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="col-xl-12 col-lg-7 no-padding">
               <div class="card shadow mb-4">
                  <div class="card-body">
                      <h1 class="h3 mb-2 text-gray-800">점검대상그룹 상세</h1>
                      <p>점검대상그룹의 상세 대상을 등록하고 삭제할 수 있습니다.</p>
                  </div>
              </div>
          </div>

          <div class="row">
            <div class="col-xl-12 col-lg-7">
            <!-- DataTales Example -->
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                  <h5 class="m-0 font-weight-bold text-primary" id="igName_section"></h5>
                  <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                      <div class="dropdown-header">점검대상그룹 관리:</div>
                      <a class="dropdown-item" href="#" id="object_reg"><i class="fas fa-plus"></i> 점검대상그룹 수정</a>
                      <a class="dropdown-item" href="#"><i class="fas fa-plus-square"></i> 점검대상 일괄등록</a>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <ul class="nav nav-tabs list-tabs category_tabs" role="tablist" id="manage_list">
                    <li class="active">
                      <a href="#" data-toggle="tab" class="all">전체</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="OS">OS</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="DBMS">DBMS</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="WEB">WEB/WAS</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="Network">Network</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="보안장비">보안장비</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="관리보안">관리보안</a>
                    </li>
                    <li class="">
                      <a href="#" data-toggle="tab" class="개인정보보호">개인정보보호</a>
                    </li>
                  </ul>
                  <div class="table-responsive">
                    <table class="table table-bordered" id="Objects_dataTable" width="100%" cellspacing="0">
                      <thead>
                      <tr>
                        <th>유형</th>
                        <th>이름</th>
                        <th>용도</th>
                        <th>담당조직</th>
                        <th>운영부서1</th>
                        <th>운영부서2</th>
                        <th>IP주소</th>
                        <th>위치정보</th>
                      </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- end of row-->

        </div>
        <!-- /.container-fluid -->
        <!-- 레이어 팝업 -->
      <div class="layer" id="manage_obj_popup">
          <div class="bg"></div>
          <div id="layer1" class="pop-layer" style="display: none; width: 1500px; margin-left: -688px; margin-top: -442px; height: 95%;">
              <div class="pop-container" style="max-height: none;">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="row">
                        <div class="col-xl-12 col-lg-7">
                          <h4>점검대상 전체 목록</h4>

                          <div class="inputs">
                            점검대상그룹 이름<span class="required" style="padding-right:30px;"> *</span>
                              <input type="text" class="text-inputs" name="igName" style=" width:60%;">
                          </div>

                          <div class="inputs">
                            담당자 <span class="required" style="padding-right:114px"> *</span>
                              <input type="text" class="text-inputs" name="manager">
                          </div>
                          <hr style="margin:35px 0px;">
                          <div class="popup-table" style="text-align: center;">
<!--                            <ul class="nav nav-tabs list-tabs category_tabs" role="tablist" id="object_list">-->
<!--                              <li class="active">-->
<!--                                <a href="#" data-toggle="tab" class="all">전체</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="OS">OS</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="DBMS">DBMS</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="WEB">WEB/WAS</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="Network">Network</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="보안장비">보안장비</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="관리보안">관리보안</a>-->
<!--                              </li>-->
<!--                              <li class="">-->
<!--                                <a href="#" data-toggle="tab" class="개인정보보호">개인정보보호</a>-->
<!--                              </li>-->
<!--                            </ul>-->
                          <div class="table-responsive">
                            <table class="table table-bordered" id="ManageObjects_dataTable" width="100%" cellspacing="0">
                              <thead>
                              <tr>
                                <th><input type="checkbox" id="check_all2"></th>
                                <th>유형</th>
                                <th>이름</th>
                                <th>용도</th>
                                <th>담당조직</th>
                                <th>운영부서1</th>
                                <th>운영부서2</th>
                                <th>IP주소</th>
                                <th>위치정보</th>
                              </tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                            <a href="#" class="btn btn-primary btn-icon-split" id="add_objs" style="margin-bottom: 20px;">
                              <span class="text" id="update_objs">점검대상 추가</span>
                            </a>
                          </div>
                        </div>
                        </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <!-- 레이어 팝업 end -->

      </div>
      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Copyright &copy; Your Website 2020</span>
          </div>
        </div>
      </footer>
      <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <th:block th:include="fragment/footer"></th:block>

  <script>

    var oids;
    var igid = geturlparam('igid');

    // 점검대상그룹 점검대상 리스팅 카테고리 클릭 이벤트
    function Change_tables(search){
      if(search == "all") {
        var search = "";
      }
      $('#Objects_dataTable').DataTable( {
        destroy : true,
        "search": {
          "search" : search
        },
        ajax : {
            type : "POST",
            url : "getObjects.do",
            dataType : "JSON",
            data : {
              'oid' : oids
            }
        },
        language : lang_kor,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrBtip>>"+"",
        buttons: buttons,
        columns : [
            {data : "type", 'className': ''},
            {data : "oname", 'className': 'dt-10'},
            {data : "purpose", 'className': 'dt-16'},
            {data : "ogroup", 'className': 'dt-16'},
            {data : "part1"},
            {data : "part2"},
            {data : "ip"},
            {data : "location", 'orderable': false, 'className': 'dt-6'},
        ],
      });
    }

    // 점검대상그룹 점검대상수정 팝업 전체 점검대상 리스팅 카테고리 클릭 이벤트
    function Change_tables_obj(search) {
      if(search == "all") {
        var search = "";
      }

      // 점검대상그룹 점검대상수정 팝업 전체 점검대상 리스팅
      $('#ManageObjects_dataTable').DataTable( {
        destroy: true,
        "search": {
          "search" : search
        },
        ajax : {
            "type" : "POST",
            "url" : "getObjectDatatable.do",
            "dataType" : "JSON",
        },
        language : lang_kor,
        bPaginate: false,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrtip>>"+"",
        columns : [
            {
              data : "oid",
              defaultContent:"",
              'targets': 0,
              'searchable': false,
              'className': 'dt-2',
              "render": function (data) {
                  return '<input type="checkbox" name="MeasureChecked" data-oid="'+data+'" value="'+data+'" class="object_checked">';
              }
              },
            {data : "type", 'className': ''},
            {data : "oname", 'className': 'dt-10'},
            {data : "purpose", 'className': 'dt-16'},
            {data : "ogroup", 'className': 'dt-16'},
            {data : "part1"},
            {data : "part2"},
            {data : "ip"},
            {data : "location", 'orderable': false, 'className': 'dt-6'},
        ],
      });

    }

    // 점검대상그룹 수정 팝업노출 이벤트
    function EditObject() {
      $.ajax({
        url : "getInspectGroup.do",
        type : "POST",
        dataType : "json",
        data : {'igid' : igid},
        success : function(data) {
          var datas = data.data;
          var confs = strToarr(datas.objects);
          $('#layer1 input[name="igName"]').val(datas.igName);
          $('#layer1 input[name="manager"]').val(datas.manager);
          for(i=0; i<confs.length; i++) {
              $("#layer1 input.object_checked[value="+confs[i]+"]").prop("checked",true);
          }
          layer_open('layer1');
        },
        error : function() {
          swal('Server error');
        }
      });
    }

    // 점검대상그룹 업데이트
    function UpdateObjects(igid, objects) {
      $.ajax({
        url : "updateInspectGroup.do",
        type : "POST",
        dataType : "json",
        data : {
            'igid' : igid,
            'igName' : $('#layer1 input[name="igName"]').val(),
            'manager' : $('#layer1 input[name="manager"]').val(),
            'objects' : objects
        }
      });
      return swal({
          title : '등록 완료!',
      }, function() {
          location.reload();
      });
    }

    // 초기 점검대상그룹 정보 로드
    $.ajax({
      type : "POST",
      url : "getInspectGroup.do",
      async : false,
      data : {
        'igid' : igid
      },
      success: function(data){
        oids = data.data.objects;
        $('#igName_section').html(data.data.igName);
      }
    });

    $(document).ready(function() {

      // 점검대상그룹 점검대상 리스링
      $('#Objects_dataTable').DataTable( {
        ajax : {
            type : "POST",
            url : "getObjects.do",
            dataType : "JSON",
            data : {
              'oid' : oids
            }
        },
        language : lang_kor,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrBtip>>"+"",
        buttons: buttons,
        columns : [
            {data : "type", 'className': ''},
            {data : "oname"},
            {data : "purpose"},
            {data : "ogroup"},
            {data : "part1"},
            {data : "part2"},
            {data : "ip"},
            {data : "location", 'orderable': false},
        ],
      });

      // 점검대상그룹 점검대상수정 팝업 전체 점검대상 리스팅
      $('#ManageObjects_dataTable').DataTable( {
        ajax : {
            "type" : "POST",
            "url" : "getObjectDatatable.do",
            "dataType" : "JSON",
        },
        language : lang_kor,
        bPaginate: false,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrtip>>"+"",
        columns : [
            {
              data : "oid",
              defaultContent:"",
              'targets': 0,
              'searchable': false,
              'className': 'dt-2',
              "render": function (data) {
                  return '<input type="checkbox" name="MeasureChecked" data-oid="'+data+'" value="'+data+'" class="object_checked">';
              }
              },
            {data : "type", 'className': ''},
            {data : "oname", 'className': 'dt-10'},
            {data : "purpose", 'className': 'dt-16'},
            {data : "ogroup", 'className': 'dt-16'},
            {data : "part1"},
            {data : "part2"},
            {data : "ip"},
            {data : "location", 'orderable': false, 'className': 'dt-6'},
        ],
      });


      // 카테고리 탭 이벤트
      $('ul li').click(function() {
        var search = $(this).children().attr('class');
        var where = $(this).parent('ul').attr('id');

        if(where == "manage_list") {
          $(this).addClass('active');
          $(this).siblings().removeClass('active');
          Change_tables(search);
        }
        if(where == "object_list") {
          $(this).addClass('active');
          $(this).siblings().removeClass('active');
          Change_tables_obj(search);
        }
      });

      // 체크박스 전체 체크 이벤트
      $('#check_all2').on('change',function() {
        var checked = $(this).is(':checked');
        if(checked) {
          $('.object_checked').prop('checked',true);
        } else {
          $('.object_checked').prop('checked',false);
        }
      });

      // 점검대상그룹 수정 이벤트
      $('#object_reg').click(function(e) {
        e.preventDefault();
        EditObject();
      });

      // 점검대상그룹 삭제 이벤트
      $('#object_del').click(function(e) {
        e.preventDefault();

        var checkBoxArr = [];

        $('input[name="MeasureChecked"]:checked').each(function() {
          checkBoxArr.push($(this).val());
        });

        if(checkBoxArr.length < 1) {
          swal({
            'title' : '',
            'text' : '삭제할 대상을 선택해주세요.',
            'type' : 'warning',
          });
        } else {
          swal({
              title : '점검대상 삭제',
              text : '선택한 점검대상을 삭제하시겠습니까?',
              type : "warning",
              showCancelButton : true,
              confirmButtonClass : "btn-danger",
              confirmButtonText : "삭제",
              cancelButtonText : "아니오",
          }, function(isConfirm) {
              if(isConfirm) {
                DeleteObject(checkBoxArr);
              }
          });
        }
      });

      // 점검대상수정 팝업 점검대상추가버튼 이벤트
      $('#update_objs').click(function(e) {
        e.preventDefault();
        var objs = [];

        $('input.object_checked:checked').each(function() {
         objs.push($(this).val());
        });

        var objs = objs.join(", ");
        UpdateObjects(igid, objs);
      });

    });
  </script>
