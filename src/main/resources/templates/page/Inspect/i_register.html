<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <th:block th:include="fragment/header"></th:block>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">
        <th:block th:include="fragment/nav"></th:block>

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="col-xl-12 col-lg-7 no-padding">
               <div class="card shadow mb-4">
                  <div class="card-body">
                      <h1 class="h3 mb-2 text-gray-800">점검계획 등록</h1>
                      <p>[Step 1]점검계획 기본정보 설정 : 모든 항목은 필수 입력 값이며, 점검계획 기간의 시작일이 포함된 월로 [점검계획 현황] 메뉴에서 확인할 수 있습니다. <br>
                        [Step 2] 점검대상 등록 : 탭으로 구분된 점검대상 분류를 선택하고 점검에 등록할 점검대상을 선택합니다. <br>
                        [Step 3] 확인 : 입력한 정보를 확인하고 점검 등록을 완료합니다.</p>
                  </div>
              </div>
          </div>

          <div class="row">

            <div class="col-lg-4">
              <div class="card mb-4 py-3 border-left-primary centered pointered" id="step_01">
                <div class="card-body no-padding register_step">
                  01 기본정보 설정
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card mb-4 py-3 border-left-secondary centered pointered" id="step_02">
                <div class="card-body no-padding register_step">
                  02 점검대상 등록
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card mb-4 py-3 border-left-secondary centered pointered" id="step_03">
                <div class="card-body no-padding register_step">
                  03 최종 확인
                </div>
              </div>
            </div>

          </div>
          <!-- /.row -->

          <div class="row">
            <div class="col-lg-12">
              <div class="card mb-4">
                <div class="card-body">
<!--                  <form action="/register_inspect" method="post">-->
                    <div class="reg-contents step_01">

                      <div class="inputs">
                        점검명<span class="required" style="padding-right: 100px;"> *</span>
                          <input type="text" class="text-inputs" name="iName" style="width: 40%;">
                      </div>

                      <div class="inputs">
                        점검항목그룹<span class="required" style="padding-right: 52px;"> *</span>
                        <select class="text-inputs" name="cgid" style="width: 40%;">
                        </select>
                      </div>

                      <div class="inputs">
                        점검유형<span class="required" style="padding-right:77px"> *</span>
                        <input style="margin-left:10px;" type="radio" name="i_type" value="인프라"> 인프라점검
                        <input style="margin-left:10px;" type="radio" name="i_type" value="ICT 월간"> ICT 월간점검
                        <input style="margin-left:10px;" type="radio" name="i_type" value="개인정보"> 개인정보점검
                        <input style="margin-left:10px;" type="radio" name="i_type" value="자체(테마)"> 자체(테마)점검
                        <input style="margin-left:10px;" type="radio" name="i_type" value="신규"> 신규점검
                      </div>

                      <div class="inputs">
                        점검기간<span class="required" style="padding-right: 85px;"> *</span>
                        <input type="date" class="text-inputs" name="idate" style="margin-right: 20px;"> ~
                        <input type="date" class="text-inputs" name="idateEx" style="margin-right: 20px;">
                      </div>

                      <div class="inputs">
                        조치계획 등록기간<span class="required" style="padding-right: 17px;"> *</span>
                        <input type="date" class="text-inputs" name="mdate" style="margin-right: 20px;"> ~
                        <input type="date" class="text-inputs" name="mdateEx" style="margin-right: 20px;">
                      </div>

                      <div class="inputs">
                        상세정보<span class="required" style="padding-right: 85px;"> *</span>
                        <textarea class="text-inputs" name="content" style="width: 40%; height: 100px;"></textarea>
                      </div>

                      <a href="#" class="btn btn-primary btn-icon-split step-btn next" style="margin-left: 40%;">
                        <span class="text">다음</span>
                      </a>

                    </div>
                    <!-- /.step-01 -->

<!--                    <div class="reg-contents step_02" style="display: none; margin: 0;">-->
<!--                      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between no-border no-background">-->
<!--                        <h6 class="m-0 font-weight-bold text-primary">점검대상 목록</h6>-->
<!--                        <div class="dropdown no-arrow">-->
<!--                          <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-->
<!--                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>-->
<!--                          </a>-->
<!--                          <div class="dropdown-menu dropdown-menu-right shadow animated&#45;&#45;fade-in" aria-labelledby="dropdownMenuLink">-->
<!--                            <div class="dropdown-header">점검대상 관리:</div>-->
<!--                            <a class="dropdown-item" href="#" id="object_reg"><i class="fas fa-plus"></i> 점검대상 등록</a>-->
<!--                            <a class="dropdown-item" href="#" id="object_del"><i class="fas fa-minus-square"></i> 점검대상 삭제</a>-->
<!--                          </div>-->
<!--                        </div>-->
<!--                      </div>-->
<!--                      <div class="card-body">-->
<!--                        <div class="table-responsive">-->
<!--                          <table class="table table-bordered" id="InspectRegister_dataTable" width="100%" cellspacing="0">-->
<!--                            <thead>-->
<!--                            <tr>-->
<!--                              <th><input type="checkbox" id="check_all"></th>-->
<!--                              <th>유형</th>-->
<!--                              <th>이름</th>-->
<!--                              <th>용도</th>-->
<!--                              <th>담당조직</th>-->
<!--                              <th>운영부서1</th>-->
<!--                              <th>운영부서2</th>-->
<!--                              <th>IP주소</th>-->
<!--                              <th>위치정보</th>-->
<!--                            </tr>-->
<!--                            </thead>-->
<!--                            <tbody></tbody>-->
<!--                          </table>-->
<!--                        </div>-->
<!--                      </div>-->
<!--                      <a href="#" class="btn btn-light btn-icon-split step-btn prev">-->
<!--                        <span class="text">이전</span>-->
<!--                      </a>-->
<!--                      <a href="#" class="btn btn-primary btn-icon-split step-btn next">-->
<!--                        <span class="text">다음</span>-->

<!--                      </a>-->
<!--                    </div>-->
                    <!-- /.step-02 -->

                    <div class="reg-contents step_02" style="display: none; margin: 0;">
                      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between no-border no-background">
                        <h6 class="m-0 font-weight-bold text-primary">점검대상그룹 목록</h6>
                      </div>
                      <div class="card-body">
                        <div class="table-responsive">
                          <table class="table table-bordered" id="InspectGroup_dataTable" width="100%" cellspacing="0">
                            <thead>
                            <tr>
                              <th><input type="checkbox" id="check_all"></th>
                              <th>이름</th>
                              <th>담당자</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                          </table>
                        </div>
                      </div>
                      <a href="#" class="btn btn-light btn-icon-split step-btn prev" style="margin-left: 43%; background-color: #e2e2e2 !important;">
                        <span class="text">이전</span>
                      </a>
                      <a href="#" class="btn btn-primary btn-icon-split step-btn next" id="step02_done">
                        <span class="text">다음</span>

                      </a>
                    </div>

                    <div class="reg-contents step_03" style="display: none;">
                        <div class="inputs">
                          점검명 : <span class="iname"></span>
                        </div>

                        <div class="inputs">
                          점검항목그룹 : <span class="cgid"></span>
                        </div>

                        <div class="inputs">
                          점검대상그룹 : <span class="igid"></span>
                        </div>

                        <div class="inputs">
                          점검기간 : <span class="idate"></span> ~ <span class="idateEx"></span>
                        </div>

                        <div class="inputs">
                          조치계획 등록기간 : <span class="mdate"></span> ~ <span class="mdateEx"></span>

                        <div class="inputs">
                          상세정보 : <span class="content"></span>
                        </div>
                        <a href="#" class="btn btn-light btn-icon-split step-btn prev" style="margin-left: 43%; background-color: #e2e2e2 !important;">
                          <span class="text">이전</span>
                        </a>
                        <a href="#" class="btn btn-primary btn-icon-split done-btn">
                          <span class="text">완료</span>
                        </a>
                    </div>
                  <!-- /.step-03 -->
<!--                  </form>-->

                </div>
              </div>
            </div>

          </div>

        </div>
        <!-- /.container-fluid -->

        <!-- 레이어 팝업 -->
      <div class="layer" id="manage_obj_popup">
          <div class="bg"></div>
          <div id="layer1" class="pop-layer" style="display: none; width: 1100px; top: 33% !important;">
              <div class="pop-container">
                  <div class="pop-conts">
                      <div class="btn-r">
                          <a href="#" class="cbtn"><i class="fas fa-times"></i></a>
                      </div>
                      <div class="row">
                        <div class="col-xl-12 col-lg-7">
                          <h4>점검대상 전체 목록</h4><hr>
                          <div class="popup-table" style="text-align: center;">
                          <div class="table-responsive">
                            <ul class="nav nav-tabs category_tabs list-tabs" role="tablist">
                              <li class="active">
                                <a href="#" data-toggle="tab" id="all">전체</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="OS">OS</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="DBMS">DBMS</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="WEB">WEB/WAS</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="Network">Network</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="gear">보안장비</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="manages">관리보안</a>
                              </li>
                              <li class="">
                                <a href="#" data-toggle="tab" id="private">개인정보보호</a>
                              </li>
                            </ul>
                            <table class="table table-bordered" id="ManageObjects_dataTable" width="100%" cellspacing="0">
                              <thead>
                              <tr>
                                <th>유형</th>
                                <th>이름</th>
                                <th>용도</th>
                                <th>담당조직</th>
                                <th>운영부서1</th>
                                <th>운영부서2</th>
                                <th>IP주소</th>
                                <th>위치정보</th>
                              </tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                          </div>
                        </div>
                        </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <!-- 레이어 팝업 end -->

      </div>
      <!-- End of Main Content -->

      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Copyright &copy; Your Website 2020</span>
          </div>
        </div>
      </footer>
      <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <th:block th:include="fragment/footer"></th:block>

<script>

    function step_contents(name, next = false, btn_type = null) {
    if(next) {

      var steps = name.slice(-1);

      if(btn_type<0) {
        var nname = Number(steps)+1;
      } else {
        if(steps == 1) {
          var nname = steps;
        } else {
          var nname = Number(steps)-1;
        }
      }
      $('.reg-contents').hide();
      $('.reg-contents.step_0'+nname).show();
      $('.card.mb-4.py-3').removeClass('border-left-primary').addClass('border-left-secondary');
      $('#step_0'+nname).removeClass('border-left-secondary').addClass('border-left-primary');
    } else {
      $('.reg-contents').hide();
      $('.reg-contents.'+name).show();
    }
    }

    function insertInspect() {
        $.ajax({
            url : "insertInspect.do",
            type : "POST",
            dataType : "json",
            data : {
                'iName'   : $('input[name="iName"]').val(),
                'cgid'     : $('select[name="cgid"]').val(),
                'igid'    : $('input.ig_checked:checked').val(),
                'type'    : $('input[name="i_type"]').val(),
                'idate'   : $('input[name="idate"]').val(),
                'idateEx' : $('input[name="idateEx"]').val(),
                'mdate'   : $('input[name="mdate"]').val(),
                'mdateEx' : $('input[name="mdateEx"]').val(),
                'content' : $('textarea[name="content"]').val(),
            },
            success:function(data) {
                swal({
                    'title' : '완료!',
                    'text'  : '점검 등록을 완료하였습니다. \n 점검계획 현황에서 등록 내역을 확인하세요.',
                    'icon'  : 'success'
                }, function() {
                    location.href="/i_dashboard";
                });
            }
        });
    }

    function DeleteObject(checked) {
      swal({
        'title' : '',
        'text' : '삭제가 완료되었습니다.',
      });
    }

    // 초기 점검대상그룹 정보 로드
    $.ajax({
      type : "POST",
      url : "getConfluenceGroupDatatable.do",
      success: function(data){
        console.log('점검항목그룹 : ');
        console.log(data);
        var cgData = data.data;
        var select_options = '<option>선택하세요</option>';
        for(i=0; i<cgData.length; i++) {
            select_options += '<option value="'+cgData[i].cgid+'">'+cgData[i].cgName+'</option>';
        }
        $('select[name="cgid"]').html(select_options);
      }
    });

    function ig_detail(oids) {
        // 점검대상그룹 점검대상 리스링
        $('#ManageObjects_dataTable').DataTable( {
            destroy : true,
            ajax : {
                type : "POST",
                url : "getObjectDatatablebyOid.do",
                dataType : "JSON",
                data : {
                  'oid' : oids
                }
            },
            language : lang_kor,
            ordering : false,
            scrollX : "100%",
            sScrollXInner: "1500px",
            dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrBtip>>"+"",
            buttons: buttons,
            columns : [
                {data : "type", 'className': ''},
                {data : "oname", 'className': 'dt-10'},
                {data : "purpose", 'className': 'dt-16'},
                {data : "ogroup", 'className': 'dt-16'},
                {data : "part1"},
                {data : "part2"},
                {data : "ip"},
                {data : "location", 'orderable': false, 'className': 'dt-6'},
            ],
        });
        return layer_open('layer1');
    }

  $(document).ready(function() {

     $('#InspectGroup_dataTable').DataTable({
        ajax : {
          type : "POST",
          url : "getInspectGroupDatatable.do",
        },
        language : lang_kor,
        ordering : false,
        scrollX : "100%",
        sScrollXInner: "1500px",
        dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrtip>>"+"",
        columns : [
                {
                  data : "igid",
                  defaultContent:"",
                  'targets': 0,
                  'searchable': false,
                  'className':'dt-2',
                  "render": function (data, type, row) {
                    return '<input type="checkbox" name="MeasureChecked" data-igid="'+data+'" data-igName="'+row['igName']+'" value="'+data+'" class="ig_checked">';
                  }
                  },
                  {
                    data : "igName",
                    defaultContent:"",
                    'targets': 1,
                    'searchable': false,
                    'className' : 'cg_cgName',
                    "render": function (data, type, row) {
                      return '<span data-igid="'+row['igid']+'">'+data+'</span>';
                    }
                  },
          {data : "manager", 'className': ''},
        ],
         success : function(data) {
            console.log(data);
        }
      });

      // Add event listener for opening and closing details
    $('#InspectGroup_dataTable tbody').on('click', 'td.cg_cgName', function (e) {
        e.preventDefault();
         var igid = $(this).children().data('igid');
         console.log(igid);
         $.ajax({
             type : "POST",
             url : "getInspectGroup.do",
             data : {
                 'igid' : igid
             },
             success: function(data){
                 ig_detail(data.data.objects);
             }
         });
    });

    // 스텝 다음 버튼 클릭 시 전환 이벤트
    $('.step-btn').click(function(e) {
      e.preventDefault();
      var s_name = $(this).parent().attr('class'),
          btn_type = $(this).attr('class').indexOf("prev"),
          step_id = s_name.slice(-7);
      step_contents(step_id, s_name, btn_type);
    });

    // 스텝 헤더 선택 시 active 및 박스내용 변경
    $('.card.mb-4.py-3').click(function(e) {
      e.preventDefault();
      var step_id = $(this).attr('id');
      $('.card.mb-4.py-3').removeClass('border-left-primary').addClass('border-left-secondary');
      $(this).removeClass('border-left-secondary').addClass('border-left-primary');
      step_contents(step_id, false);
    });

    $('#step02_done').click(function (e) {
        e.preventDefault();

        var checkBoxArr = [];
        $('input[name="igid"]:checked').each(function() {
          checkBoxArr.push($(this).val());
        });

        if(checkBoxArr.length > 1) {
            swal('점검대상그룹을 하나만 선택해주세요');
            $('input[name="igid"]').prop('checked',false);
        }
    });

    $('#step02_done, #step_03').click(function(e) {

        var iname   = $('input[name="iName"]').val(),
            cgid     = $('select[name="cgid"]').val(),
            igid    = $('input.ig_checked:checked').data('igname'),
            idate   = $('input[name="idate"]').val(),
            idateEx = $('input[name="idateEx"]').val(),
            mdate   = $('input[name="mdate"]').val(),
            mdateEx = $('input[name="mdateEx"]').val(),
            content = $('textarea[name="content"]').val();

        $('span.iname').html(iname);
        $('span.cgid').html(cgid);
        $('span.igid').html(igid);
        $('span.idate').html(idate);
        $('span.idateEx').html(idateEx);
        $('span.mdate').html(mdate);
        $('span.mdateEx').html(mdateEx);
        $('span.content').html(content);

    });

    $('.done-btn').click(function(e) {
      e.preventDefault();
      insertInspect();
    });

    $('ul.category_tabs li').click(function(){
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
        var igid = $(this).children().data('igid');
        var search = $(this).children().attr('id');
        console.log(igid);

         if(search == "all") {
            var search = "";
          }
          $('#ManageObjects_dataTable').DataTable( {
            destroy: true,
            ajax : {
                "type" : "POST",
                "url" : "getObjectDatatable.do",
                "dataType" : "JSON",
            },
              data : {
                  'oid' : igid
                },
            language : lang_kor,
            ordering : false,
            scrollX : "100%",
            sScrollXInner: "1500px",
            "search": {
              "search" : search
            },
            dom: "<'row'<'col-xl-12 col-lg-7 no-padding'lfrtip>>"+"",
            columns : [
                {data : "type", 'className': ''},
                {data : "oname", 'className': 'dt-10'},
                {data : "purpose", 'className': 'dt-16'},
                {data : "ogroup", 'className': 'dt-16'},
                {data : "part1"},
                {data : "part2"},
                {data : "ip"},
                {data : "location", 'orderable': false, 'className': 'dt-6'},
            ],
          });
      });


  });

</script>